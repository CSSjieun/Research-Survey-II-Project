---
title: "Final Assignment"
author: "Valeria Contreras"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    df_print: paged
  html_notebook:
    toc: false
    df_print: paged
---

.

```{=html}
<style>
body {
text-align: justify}
</style>
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=T, message=FALSE, warning=FALSE, knitr.purl.inline = TRUE )
```


```{r}
# LOADING REQUIRED LIBRARIES

library(tidyverse)
library(dplyr)
library(forcats)
library(gmodels)
library(haven)
```

## DATA COLLECTION AND WRANGLING

We load the original given dataset from the Special Eurobarometer 493: Discrimination
in the EU. This survey includes responses regarding societal attitudes
and legal challenges among 27438 respondents across 28 countries between 09-
21/05/2019.

Based on previous literature on this topic (check the narrative doc for more information),
we select and initial set of independent variables that, together with the dependent 
variable q19 ("Do you think that transgender persons should be able to change their 
civil documents to match their inner gender identity?"), will form the individual level
factors. These independent variables are:

  - Generic individual aspects:
    - ORIGIN: country and isocntry
    - GENDER: d10 (then: male)
    - AGE: d11 (then: age_cat)
    - **EDUCATION: (d8r1) ??????????????????????????**
    - RELIGION: sd3 (then: religion and religion_group)
    - GENERAL POLITICAL ATTITUDES:
    - POLITICAL STANCE: d1r1 (then: left_right)
    
  - LGTBI related aspects at individual level:
    - CONTACT: 
      - sd1_4 (gay lesbian or bisexual)
      - sd1_7 (transgender/transexual)
      - sd1_8 (intersext)
    - DISCRIMINATION PERCEIVED (LGTBI): qc1 (then: discrimination)
    - ATTITUDES TOWARDS THE LGTBI COMMUNITY:
    - EXPERIENCES OF DISCRIMINATION (LGTBI):
    - LAWS & POLICIES:
    

  -

```{r}
Disc <- read_dta("Data/ZA7575.dta")
head(Disc)

Disc_clean <- Disc %>% 
  select(isocntry,country, d10, d11, d8r1, d1r1, sd3, sd1_4, sd1_7, sd1_8, qc19, qc20)

unique(Disc$isocntry)

```
### Encoding: the individual perspective

Now, we need to factorize the values of the independent variables and recode the "refusal"
and "DK" answers as NAs.

#### Country

Encoding the country name:

```{r}
#Put the complete name of the countries. 
Disc_clean <- Disc |> mutate(country = case_when(
  isocntry== "BE" ~ "Belgium",
  isocntry== "DK" ~ "Denmark",
  isocntry== "GR" ~ "Greece",
  isocntry== "ES" ~ "Spain",
  isocntry== "FI" ~"Finland",
  isocntry== "FR" ~ "France",
  isocntry== "IE" ~ "Ireland",
  isocntry== "IT" ~ "Italy",
  isocntry== "LU" ~ "Luxembourg",
  isocntry== "NL" ~ "Netherlands",
  isocntry== "AT" ~ "Austria",
  isocntry== "PT" ~ "Portugal",
  isocntry== "SE" ~ "Sweden",
  isocntry== "DE-W" ~ "Germany (specifically the state of North Rhine-Westphalia)",
  isocntry== "DE-E" ~ "Germany (specifically the state of Berlin)",
  isocntry== "GB" ~ "United Kingdom",
  isocntry== "BG" ~ "Bulgaria",
  isocntry== "CY" ~ "Cyprus",
  isocntry== "CZ" ~ "Czech Republic",
  isocntry== "EE" ~ "Estonia",
  isocntry== "HU" ~ "Hungary",
  isocntry== "LV" ~ "Latvia",
  isocntry== "LT" ~ "Lithuania",
  isocntry== "MT" ~ "Malta",
  isocntry== "PL" ~ "Poland",
  isocntry== "RO" ~ "Romania",
  isocntry== "SK" ~ "Slovakia",
  isocntry== "SI" ~ "Slovenia",
  isocntry== "HR" ~ "Croatia",
  TRUE ~ NA_character_))
```

#### Gender

Encoding gender:

```{r}
# Encoding gender (Original-> 1: Man 2: Woman)

Disc_clean <- Disc_clean %>%
  mutate(male = car::recode(d10, "2=0"),
    male = factor(male, levels = c(0, 1), labels = c("female", "male")))

# Distribution of gender surveyed per country
table(Disc_clean$country, Disc_clean$male)
```

#### Age

Encoding age:

```{r}
# Encoding age (Original-> number, 99: refusal)
Disc_clean <- Disc_clean |>
  mutate(
    d11 = replace(d11, d11 > 98, NA) # 999 and other values above 
  )

Disc_clean <- Disc_clean |>
  mutate(
    age_cat = cut(d11, breaks = c(0, 19, 29, 44, 64, 98),
                  labels = c("<20", "20-29", "30-44", "45-64", ">=65"))
  )

# Distribution of age categories by country

with(Disc_clean, table(country, age_cat))

```

#### Education

The education variable per categories is the following:
1	Up to 14 years			
2	15 years			
3	16 years			
4	17 years			
5	18 years			
6	19 years			
7	20 years			
8	21 years			
9	22 years and older			
10	Still studying
11	No full-time education			
97	Refusal			
98	DK

```{r}


```


#### Political stance: left-center-right

Encoding political stance (left-right):

1	(1 - 4) Left			
2	(5 - 6) Centre			
3	(7 -10) Right			
9	DK/Refusal

```{r}
Disc_clean <- Disc_clean |>
  mutate(
    left_right = car::recode(d1r1, "9=NA"),
    left_right = factor(left_right, labels = c("Left", "Center", "Right"))
  )


# Distribution of political stance categories by country

with(Disc_clean, table(country, left_right))
```
#### Religion

Encoding religion variable. Original:
1	Catholic			
2	Orthodox Christian			
3	Protestant			
4	Other Christian			
5	Jewish			
6	Muslim - Shia			
7	Muslim - Sunni			
8	Other Muslim			
9	Sikh			
10	Buddhist
11	Hindu			
12	Atheist			
13	Non believer or agnostic			
14	Other			
15	Refusal (SPONTANEOUS)			
16	DK

```{r}
# Encoding religions (Original-> 1-14: Religions; 15: Refusal; 16: )

Disc_clean <- Disc_clean %>% 
  mutate(
    religion = car::recode(sd3, "15=NA; 16=NA"),
    religion = factor(religion, levels = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14),
                      labels= c("Catholic", "Orthodox Christian", "Protestant",
                                "Other Christian", "Jewish","Muslim - Shia",
                                "Muslim - Sunni","Other Muslim", "Sikh", "Buddhist",
                                "Hindu", "Atheist","Agnostic","Other")))


```

We also create another factor variable to capture in general terms if the person is religious or not:

```{r}
# Recoding religion valiable in the following groups: Religious: 1, Atheist: 2, Agnostic: 3, Other: 4)
Disc_clean <- Disc_clean |>
  mutate(
    religion_group = case_when(
      sd3 %in% c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11) ~ "1",
      sd3 %in% c(12) ~ "2",
      sd3 %in% c(13) ~ "3",
      sd3 %in% c(14) ~ "4",
      TRUE ~ NA_character_
    )
  ) |>
  mutate(
    religion_group = fct_recode(religion_group,
                            "Religious" = "1",
                            "Atheist" = "2",
                            "Agnostic" = "3",
                            "Other" = "4")
  )

with(Disc_clean, table(country, religion_group))
```
"Buddhist" = "10",
                            "Hindu" = "11",
                            "Atheist" = "12",
                            "Agnostic" = "13",
                            "Other" = "14"))


#### Discrimination_perceived

Encoding religion

#### Discrimination experienced

Encoding religion

#### Contact with LGBT community

Original question: "Do you have friends or acquaintances who are…?" Variables:
sd1_4 CONTACT: gay lesbian or bisexual
sd1_7 CONTACT: transgender/transexual
sd1_8 CONTACT: intersext

```{r}
# Contact: gay, lesbian, bisexual

Disc_clean <- Disc_clean %>% 
  mutate(contact_gay = car::recode(sd1_4, "2=0; 3=NA; 4=NA"),
         contact_gay = factor(contact_gay, levels = c(0, 1), labels= c("No", "Yes"))
  )

# Contact: transgender, transexual

Disc_clean <- Disc_clean %>% 
  mutate(contact_trans = car::recode(sd1_7, "2=0; 3=NA; 4=NA"),
         contact_trans = factor(contact_trans, levels = c(0, 1), labels= c("No", "Yes"))
  )
 
Disc_clean <- Disc_clean %>% 
  mutate(contact_inter = car::recode(sd1_8, "2=0; 3=NA; 4=NA"),
         contact_inter = factor(contact_inter, levels = c(0, 1), labels= c("No", "Yes"))
  )



sd1_7

sd1_8
with(Disc_clean, table(country, ...))
```


#### Encoding dependent variable: qc19

Convert numeric answers from qc19 to character answers

```{r}
Disc <- Disc %>% mutate(change_docs = case_when(
  qc19 == 1 ~ "Yes",
  qc19 == 2 ~ "No", 
  qc19 == 3 ~ "DK", 
  TRUE ~ NA_character_)) 

# Need for factorize
```


### Measuring supprotiveness for LGBTI communities in different countries

Count the qc19 answers by country 

```{r}
library(dplyr)

#sum counts 
opinions_by_country <- Disc %>%
  group_by(country, change_docs) %>%
  summarise(count = n()) %>%
  pivot_wider(names_from = change_docs, values_from = count, values_fill = 0)

opinions_by_country

#percentage counts 
Disc %>%
  group_by(country, change_docs) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  group_by(country) %>%
  mutate(total_count = sum(count)) %>%
  mutate(percentage = (count / total_count) * 100) %>%
  select(country, change_docs, percentage) %>%
  pivot_wider(names_from = change_docs, values_from = percentage, values_fill = 0)

```
```{r}
#Top 5 of countries that think that transgender persons should be able to change their civil documents to match their inner gender identity
country_with_most_yes <- opinions_by_country %>%
  filter(Yes > 0) %>%
  arrange(desc(Yes)) %>%
  head(5)
country_with_most_yes
```

```{r}
#Top 5 of countries that do not think that transgender persons should be able to change their civil documents to match their inner gender identity
country_with_most_no <- opinions_by_country %>%
  filter(No > 0) %>%
  arrange(desc(No)) %>%
  head(5)
country_with_most_no
```

```{r}
#Top 5 of countries that do not think that transgender persons should be able to change their civil documents to match their inner gender identity
country_with_most_DK <- opinions_by_country %>%
  filter(DK > 0) %>%
  arrange(desc(DK)) %>%
  head(5)
country_with_most_DK
```

Life satisfaction 

```{r}
Disc <- Disc %>% mutate(Life_satisf = case_when(
  d70 == 1 ~ "Very_satisfied",
  d70 == 2 ~ "Fairly_satisfied", 
  d70 == 3 ~ "Not_very_satisfied",
  d70== 4 ~ "Not_at_all_satisfied",
  d70== 5 ~ "DK",
  TRUE ~ NA_character_))  
```

```{r}
#Life satisfaction by country sum counts 
ls_by_country <- Disc %>%
  group_by(country, Life_satisf) %>%
  summarise(count = n()) %>%
  pivot_wider(names_from = Life_satisf, values_from = count, values_fill = 0)

ls_by_country

```

```{r}
#percentage counts 
survey <- Disc %>%
  group_by(country, Life_satisf) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  group_by(country) %>%
  mutate(total_count = sum(count)) %>%
  mutate(percentage = (count / total_count) * 100) %>%
  select(country, Life_satisf, percentage) %>%
  pivot_wider(names_from = Life_satisf, values_from = percentage, values_fill = 0)

survey_germany <- data.frame(
  country = "Germany",
  DK = (0.36697248)/2, 
  "Fairly_satisfied" = (60.91743+55.04032)/2,
  "Not_at_all_satisfied" = (3.3027523+1.0080645)/2,
  "Not_very_satisfied" = (12.660550+6.451613)/2,
  "Very_satisfied" = (22.752294+37.500000)/2
 )

survey <- rbind(survey, survey_germany)
survey <- survey |> filter(country != "Germany (specifically the state of Berlin)") |> 
  filter(country != "Germany (specifically the state of North Rhine-Westphalia)")

survey
```

### Encoding: the national perspective

#### GDP per capita 

```{r}
#dataset from World Bank 
library(readr)
GDP <- read_csv("Data/GDP.csv")

```

Tidy the data 
```{r}
GDP <- GDP |> na.omit() |>  #remove rows with empty spaces 
  rename(Country =`Country Name`,Indicator = `Series Name`, value = `2019 [YR2019]`) 


GDP$value <- as.numeric(GDP$value)

GDP1 <- GDP |> 
  pivot_wider(names_from = "Indicator", values_from =  "value") |> 
  pivot_wider(names_from = `Series Code`, values_from = `GDP per capita (current US$)`: `GDP (current US$)`)|> 
  rename(GDP_per_capita = `GDP per capita (current US$)_NY.GDP.PCAP.CD`, GDP = `GDP (current US$)_NY.GDP.MKTP.CD`) |>
  select(Country,`Country Code`,GDP_per_capita, GDP)

options(scipen = 999)
GDP1[26,1] <- "Slovakia"

```




#### Religious data

```{r}
install.packages("xlsx")
library(tidyr)
library(dplyr)
library(xlsx)

religion <- readxl::read_excel("./Data/Religious_Composition_by_Country_2010-2050.xlsx")
head(religion)

unique(religion$Year)

religion <- religion |> filter(Year == 2020)
religion <- religion |> filter(Region == "Europe")
religion <- religion |> select(Country, "All Religions")

religion

populaiton <- read.csv("./Data/API_SP.POP.TOTL_DS2_en_csv_v2_85.csv", skip = 4, header = TRUE)
populaiton <- populaiton |> select("Country.Name", X2020)
populaiton <- populaiton |> rename("Country" = "Country.Name")
populaiton <- populaiton |> rename("populaiton" = "X2020")

religion <- religion |> rename("country" = "Country")

survey2 <- survey |> left_join(religion)

survey2[5, 7] <- "1,041,228"

survey2$"All Religions" <- as.numeric(gsub(",", "", survey2$"All Religions"))

survey2 <- as.data.frame(survey2)
survey2 <- survey2 |> rename("all_religion" = "All Religions")
survey2[6,1] <- "Czechia" 
survey2
```

Joining GDP per capita and total GDP to the main dataset. 

```{r}
# select(GDP, GDP_per_capita, country)
survey2 <- left_join(survey2, GDP1, by = c("country" = "Country")) 
survey2 <- survey2 |> select(!"Country Code")
survey2
```


RAINBOW DATASET

The following dataset is from the "Rainbow index 2019" of ILGA-EUROPE’S annual benchmarking tool, this index ranks 49 European countries by their LGBTI equality laws and policies, taking into account those policies safeguarding equality and human rights of LGBTI poeple (https://www.ilga-europe.org/report/rainbow-europe-2019/). 

1 - national/federal application 
2 - applicable is some regions only 
3 - No applications 


Each country has a score based on the presence or absence of these laws and policies, as well as the comprehensiveness and effectiveness of such measures,the total score at the end of the dataset reflects the overall level of LGBTQI+ equality in each country ( the higher score the better LGBTQI+ equality within the country). 


```{r}
library(readxl)
rainbow_2019 <- read_excel("Data/rainbow-2019.xlsx")
head(rainbow_2019)
rainbow_2019 <- rainbow_2019 |> rename("country" = "Country")

```



```{r}
#Top 5 countries with the highest score of LGBTQI+ equality
rainbow_2019 |> 
  arrange(desc(`Score`)) |> 
  head(5)
```

```{r}
#Top 5 countries with the lowest score of LGBTQI+ equality
rainbow_2019 |> 
  arrange(`Score`) |> 
  head(5)
```
```{r}
survey2 <- left_join(survey2, rainbow_2019)
survey2
```


### Missing data imputation

# Linear Regression

```{r}

```


## GOALS

### 1. Cross-country differences in supporting levels:




### 2. Predictivd model for other countries:
#### 1. Decision Tree

```{r}
# mean satisfy score is 82.6942 so if sum of satisfaction do not reach that point, we regard it not satisfaction
sum((survey2$Fairly_satisfied+survey2$Very_satisfied))/28

survey2_classi <- survey2 |> mutate(satisfy = 
                               ifelse(Fairly_satisfied+Very_satisfied<82.6942, 0, 1), .before=all_religion)
survey2_classi <- survey2_classi |> select(-DK, -Fairly_satisfied, -Not_at_all_satisfied, -Not_very_satisfied, -Very_satisfied)

survey2_classi <- survey2_classi |> mutate(satisfy_label = ifelse(satisfy == 1, "YES", "NO"), .after="satisfy")
survey2_classi$satisfy = NULL
survey2_classi$country <- factor(survey2_classi$country)
survey2_classi$satisfy_label <- factor(survey2_classi$satisfy_label)
levels(survey2_classi$satisfy_label) <- c("No", "Yes")
survey2_classi
```

### Splitting data

```{r}
library(caret)

set.seed(123)
in_train <- createDataPartition(survey2_classi$satisfy_label, p = 0.8, list = FALSE)  # 70% for training
training <- survey2_classi[in_train,]
testing <- survey2_classi[-in_train,]
nrow(training)
nrow(testing)
length(survey2_classi$satisfy_label)
```

### fold validation

```{r}
library(rpart)

control = rpart.control(minsplit = 30, maxdepth = 10, cp=0.01)
```

```{r}
model = satisfy_label ~.
dtFit <- rpart(model, data=training, method = "class", control = control)
summary(dtFit)
```

```{r}
library(rpart.plot)
rpart.plot(dtFit, digits=3)
```
```{r}
control = rpart.control(minsplit = 8, maxdepth = 12, cp=0.001)
dtFit <- rpart(model, data=training, method = "class", control = control)

rpart.plot(dtFit, digits = 3)
```

```{r}
dtPred <- predict(dtFit, testing, type = "class")

dtProb <- predict(dtFit, testing, type = "prob")

prediction <- as.factor(ifelse(dtProb[,2] > 0.5, "Yes", "No"))
levels(testing$satisfy_label)

confusionMatrix(prediction, testing$satisfy_label)$table
confusionMatrix(prediction, testing$satisfy_label)$overall[1:2]
```

```{r}

```

## Challenges:

In the encoding process, some variables like education () were difficult to encode as we were interested in the level of education, not the age when the participant stopped full-time studies (which does not imply neccesarily the level of studies acquired). A correlation with the ISCED levels could be possible but not rigorous (e.g. older people obtaining their highschool diploma).