---
title: "Final Assignment"
author: "Valeria Contreras"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    df_print: paged
  html_notebook:
    toc: false
    df_print: paged
---

.

```{=html}
<style>
body {
text-align: justify}
</style>
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=T, message=FALSE, warning=FALSE, knitr.purl.inline = TRUE )
```

```{r}
library(tidyverse)
library(dplyr)
library(forcats)
library(gmodels)
library(haven)
```

###Read data 
```{r}
Disc <- read_dta("Data/ZA7575.dta")
head(Disc)

Disc |> select(isocntry,country,qc19)
unique(Disc$isocntry)

```


```{r}
#Put the complete name of the countries. 
Disc <- Disc |> mutate(country = case_when(
  isocntry== "BE" ~ "Belgium",
  isocntry== "DK" ~ "Denmark",
  isocntry== "GR" ~ "Greece",
  isocntry== "ES" ~ "Spain",
  isocntry== "FI" ~"Finland",
  isocntry== "FR" ~ "France",
  isocntry== "IE" ~ "Ireland",
  isocntry== "IT" ~ "Italy",
  isocntry== "LU" ~ "Luxembourg",
  isocntry== "NL" ~ "Netherlands",
  isocntry== "AT" ~ "Austria",
  isocntry== "PT" ~ "Portugal",
  isocntry== "SE" ~ "Sweden",
  isocntry== "DE-W" ~ "Germany (specifically the state of North Rhine-Westphalia)",
  isocntry== "DE-E" ~ "Germany (specifically the state of Berlin)",
  isocntry== "GB" ~ "United Kingdom",
  isocntry== "BG" ~ "Bulgaria",
  isocntry== "CY" ~ "Cyprus",
  isocntry== "CZ" ~ "Czech Republic",
  isocntry== "EE" ~ "Estonia",
  isocntry== "HU" ~ "Hungary",
  isocntry== "LV" ~ "Latvia",
  isocntry== "LT" ~ "Lithuania",
  isocntry== "MT" ~ "Malta",
  isocntry== "PL" ~ "Poland",
  isocntry== "RO" ~ "Romania",
  isocntry== "SK" ~ "Slovakia",
  isocntry== "SI" ~ "Slovenia",
  isocntry== "HR" ~ "Croatia",
  TRUE ~ NA_character_))
```

Convert numeric answers from qc19 to character answers

```{r}
Disc <- Disc %>% mutate(change_docs = case_when(
  qc19 == 1 ~ "Yes",
  qc19 == 2 ~ "No", 
  qc19 == 3 ~ "DK", 
  TRUE ~ NA_character_)) 
```

### Measuring supprotiveness for LGBTI communities in different countries
Count the qc19 answers by country 

```{r}
library(dplyr)

#sum counts 
opinions_by_country <- Disc %>%
  group_by(country, change_docs) %>%
  summarise(count = n()) %>%
  pivot_wider(names_from = change_docs, values_from = count, values_fill = 0)

opinions_by_country

#percentage counts 
Disc %>%
  group_by(country, change_docs) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  group_by(country) %>%
  mutate(total_count = sum(count)) %>%
  mutate(percentage = (count / total_count) * 100) %>%
  select(country, change_docs, percentage) %>%
  pivot_wider(names_from = change_docs, values_from = percentage, values_fill = 0)

```
```{r}
#Top 5 of countries that think that transgender persons should be able to change their civil documents to match their inner gender identity
country_with_most_yes <- opinions_by_country %>%
  filter(Yes > 0) %>%
  arrange(desc(Yes)) %>%
  head(5)
country_with_most_yes
```

```{r}
#Top 5 of countries that do not think that transgender persons should be able to change their civil documents to match their inner gender identity
country_with_most_no <- opinions_by_country %>%
  filter(No > 0) %>%
  arrange(desc(No)) %>%
  head(5)
country_with_most_no
```

```{r}
#Top 5 of countries that do not think that transgender persons should be able to change their civil documents to match their inner gender identity
country_with_most_DK <- opinions_by_country %>%
  filter(DK > 0) %>%
  arrange(desc(DK)) %>%
  head(5)
country_with_most_DK
```

Life satisfaction 

```{r}
Disc <- Disc %>% mutate(Life_satisf = case_when(
  d70 == 1 ~ "Very_satisfied",
  d70 == 2 ~ "Fairly_satisfied", 
  d70 == 3 ~ "Not_very_satisfied",
  d70== 4 ~ "Not_at_all_satisfied",
  d70== 5 ~ "DK",
  TRUE ~ NA_character_))  
```

```{r}
#Life satisfaction by country sum counts 
ls_by_country <- Disc %>%
  group_by(country, Life_satisf) %>%
  summarise(count = n()) %>%
  pivot_wider(names_from = Life_satisf, values_from = count, values_fill = 0)

ls_by_country
```

```{r}
#percentage counts 
survey <- Disc %>%
  group_by(country, Life_satisf) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  group_by(country) %>%
  mutate(total_count = sum(count)) %>%
  mutate(percentage = (count / total_count) * 100) %>%
  select(country, Life_satisf, percentage) %>%
  pivot_wider(names_from = Life_satisf, values_from = percentage, values_fill = 0)

survey_germany <- data.frame(
  country = "Germany",
  DK = (0.36697248)/2, 
  "Fairly_satisfied" = (60.91743+55.04032)/2,
  "Not_at_all_satisfied" = (3.3027523+1.0080645)/2,
  "Not_very_satisfied" = (12.660550+6.451613)/2,
  "Very_satisfied" = (22.752294+37.500000)/2
 )

survey <- rbind(survey, survey_germany)
survey <- survey |> filter(country != "Germany (specifically the state of Berlin)") |> 
  filter(country != "Germany (specifically the state of North Rhine-Westphalia)")

survey
```

## Target Variable

```{r}
qc19 <- opinions_by_country 

Germany <- tibble(country = c("Germany"),
                  DK = c((88+116)/2),
                  No = c((107+172)/2),
                  Yes = c((350+704)/2))

qc19 <- rbind(qc19, Germany)
qc19 <- qc19 |> filter(country != "Germany (specifically the state of Berlin)" &  
                       country != "Germany (specifically the state of North Rhine-Westphalia)")

qc19 <- qc19 |> rename("Don't_Know" = "DK")
print(qc19)
  
```

## Merge target variable and satisfaction variables

```{r}
survey <- left_join(qc19, survey, by = "country")
```


# Challenges
## 1. Cross-country differences in supporting levels:

ADD GDP PER COUNTRY AND GDP PER CAPITA PER COUNTRY 

```{r}
#dataset from World Bank 
library(readr)
GDP <- read_csv("Data/GDP.csv")

```

Tidy the data 
```{r}
GDP <- GDP |> na.omit() |>  #remove rows with empty spaces 
  rename(Country =`Country Name`,Indicator = `Series Name`, value = `2019 [YR2019]`) 


GDP$value <- as.numeric(GDP$value)

GDP1 <- GDP |> 
  pivot_wider(names_from = "Indicator", values_from =  "value") |> 
  pivot_wider(names_from = `Series Code`, values_from = `GDP per capita (current US$)`: `GDP (current US$)`)|> 
  rename(GDP_per_capita = `GDP per capita (current US$)_NY.GDP.PCAP.CD`, GDP = `GDP (current US$)_NY.GDP.MKTP.CD`) |>
  select(Country,`Country Code`,GDP_per_capita, GDP)

options(scipen = 999)
GDP1[26,1] <- "Slovakia"

GDP1
```


# Religious data

```{r}
install.packages("xlsx")
library(tidyr)
library(dplyr)
library(xlsx)

religion <- readxl::read_excel("./Data/Religious_Composition_by_Country_2010-2050.xlsx")
head(religion)

unique(religion$Year)

religion <- religion |> filter(Year == 2020)
religion <- religion |> filter(Region == "Europe")
religion <- religion |> select(Country, "All Religions")

print(religion)

religion <- religion |> rename("country" = "Country")

survey2 <- survey |> left_join(religion)

survey2[5,10] = "1,041,228"

survey2$"All Religions" <- as.numeric(gsub(",", "", survey2$"All Religions"))

survey2 <- as.data.frame(survey2)
survey2 <- survey2 |> rename("all_religion" = "All Religions")
survey2[6,1] <- "Czechia" 
print(survey2)
```

Joining GDP per capita and total GDP to the main dataset. 

```{r}
# select(GDP, GDP_per_capita, country)
survey2 <- left_join(survey2, GDP1, by = c("country" = "Country")) 
survey2 <- survey2 |> select(!"Country Code")

print(survey2)
```


RAINBOW DATASET

The following dataset is from the "Rainbow index 2019" of ILGA-EUROPEâ€™S annual benchmarking tool, this index ranks 49 European countries by their LGBTI equality laws and policies, taking into account those policies safeguarding equality and human rights of LGBTI poeple (https://www.ilga-europe.org/report/rainbow-europe-2019/). 

1 - national/federal application 
2 - applicable is some regions only 
3 - No applications 


Each country has a score based on the presence or absence of these laws and policies, as well as the comprehensiveness and effectiveness of such measures,the total score at the end of the dataset reflects the overall level of LGBTQI+ equality in each country ( the higher score the better LGBTQI+ equality within the country). 


```{r}
library(readxl)
rainbow_2019 <- read_excel("Data/rainbow-2019.xlsx")
head(rainbow_2019)
rainbow_2019 <- rainbow_2019 |> rename("country" = "Country")

```

# Rainbow

```{r}
#Top 5 countries with the highest score of LGBTQI+ equality
rainbow_2019 |> 
  arrange(desc(`Score`)) |> 
  head(5)
```

```{r}
#Top 5 countries with the lowest score of LGBTQI+ equality
rainbow_2019 |> 
  arrange(`Score`) |> 
  head(5)
```

## Merging survey2 and rainbow_2019

```{r}
survey2 <- left_join(survey2, rainbow_2019)
print(survey2)
```


# Linear Regression

```{r}
lm(survey2 ~ )
```


## 2. Predictivd model for other countries:
### 1. Decision Tree

```{r}
# mean satisfy score is 82.6942 so if sum of satisfaction do not reach that point, we regard it not satisfaction
survey2_classi <- survey2 |> mutate(satisfy = 
                               ifelse(Fairly_satisfied+Very_satisfied<82.6942, 0, 1), .before=all_religion)
survey2_classi <- survey2_classi |> select(-DK, -Fairly_satisfied, -Not_at_all_satisfied, -Not_very_satisfied, -Very_satisfied)

survey2_classi <- survey2_classi |> mutate(satisfy_label = ifelse(satisfy == 1, "YES", "NO"), .after="satisfy")
survey2_classi$satisfy = NULL
survey2_classi$country <- factor(survey2_classi$country)
survey2_classi$satisfy_label <- factor(survey2_classi$satisfy_label)
levels(survey2_classi$satisfy_label) <- c("No", "Yes")
survey2_classi
```

### Splitting data

```{r}
library(caret)

set.seed(123)
in_train <- createDataPartition(survey2_classi$satisfy_label, p = 0.8, list = FALSE)  # 70% for training
training <- survey2_classi[in_train,]
testing <- survey2_classi[-in_train,]
nrow(training)
nrow(testing)
length(survey2_classi$satisfy_label)
```

### fold validation

```{r}
library(rpart)

control = rpart.control(minsplit = 30, maxdepth = 10, cp=0.01)
```

```{r}
model = satisfy_label ~.
dtFit <- rpart(model, data=training, method = "class", control = control)
summary(dtFit)
```

```{r}
library(rpart.plot)
rpart.plot(dtFit, digits=3)
```
```{r}
control = rpart.control(minsplit = 8, maxdepth = 12, cp=0.001)
dtFit <- rpart(model, data=training, method = "class", control = control)

rpart.plot(dtFit, digits = 3)
```

```{r}
dtPred <- predict(dtFit, testing, type = "class")

dtProb <- predict(dtFit, testing, type = "prob")

prediction <- as.factor(ifelse(dtProb[,2] > 0.5, "Yes", "No"))
levels(testing$satisfy_label)

confusionMatrix(prediction, testing$satisfy_label)$table
confusionMatrix(prediction, testing$satisfy_label)$overall[1:2]
```

```{r}

```

